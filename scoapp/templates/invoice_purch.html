{% include 'user_navbar.html' %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Scoruda</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: Arial, sans-serif; height: 100%; }
        .main-container { display: none; justify-content: space-between; margin-top: 20px; padding: 0 20px; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-width: 600px; margin-right: 30px; }
        .image-grid img { width: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .selected-products-container { max-width: 600px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .product-selection { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 10px; }
        .product-selection input { width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        .product-selection button { background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .product-selection button:hover { background-color: #e60000; }
        .form-container button, .payment-button { width: 100%; padding: 12px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; font-size: 16px; margin-top: 20px; }
        .payment-button:hover, .form-container button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <center><h1>{{ head }}</h1></center>

    <form id="order-form" method="POST">
        {% csrf_token %}
        <div class="form-container">
            <div class="form-section" id="customer-section">
                <label for="selbuy">Seller:</label>
                {{ form.selbuy }}
            </div>

            <div class="form-section" id="payment-method-section" style="display: none;">
                <label for="mode">Payment Method:</label>
                {{ form.mode }}
            </div>

            <div class="main-container" id="product-selection-container">
                <div class="image-grid" id="image-grid" style="display: none;">
                    {% for item in items %}
                        <a href="javascript:void(0);" onclick="selectProduct('{{ item.id }}', '{{ item.product }}')">
{% for item in items %}
  <a href="javascript:void(0);" onclick="selectProduct('{{ item.id }}', '{{ item.product }}')">
    {% if item.image %}
      <img src="{{ item.image.url }}" alt="{{ item.product }}" />
    {% else %}
      <img src="/static/placeholder.jpg" alt="{{ item.product }}" />
    {% endif %}
  </a>
{% endfor %}
                        </a>
                    {% endfor %}
                </div>

                <div class="selected-products-container">
                    <div id="selected-product-list"></div>
                    <a href="#" id="payment-button" class="payment-button" style="display: none;">MAKE PAYMENT</a>
                </div>
            </div>
        </div>
    </form>

    <script>
        const selectedProducts = [];

        window.onload = function() {
            const customerField = document.querySelector('[name="selbuy"]');
            if (customerField) customerField.focus();
        };

        document.querySelector('[name="selbuy"]').addEventListener('change', function () {
            if (this.value) {
                document.getElementById('payment-method-section').style.display = 'block';
            }
        });

        document.querySelector('[name="mode"]').addEventListener('change', function () {
            if (this.value) {
                document.getElementById('image-grid').style.display = 'grid';
                document.getElementById('payment-button').style.display = 'block';
                document.querySelector('.main-container').style.display = 'flex';
            }
        });

        function selectProduct(productId, productName) {
            if (!selectedProducts.some(p => p.id === productId)) {
                selectedProducts.push({ id: productId, name: productName, qty: 1 });

                const container = document.createElement('div');
                container.className = 'product-selection';
                container.id = `product-${productId}`;

                container.innerHTML = `
                    <input type="text" value="${productName}" readonly />
                    <input type="number" min="1" value="1" onchange="updateQuantity('${productId}', this.value)" />
                    <button type="button" onclick="removeProduct('${productId}')">Remove</button>
                `;

                document.getElementById('selected-product-list').appendChild(container);
            }
        }

        function updateQuantity(productId, newQty) {
            const product = selectedProducts.find(p => p.id === productId);
            if (product) product.qty = newQty;
        }

        function removeProduct(productId) {
            const index = selectedProducts.findIndex(p => p.id === productId);
            if (index !== -1) {
                selectedProducts.splice(index, 1);
                const el = document.getElementById(`product-${productId}`);
                if (el) el.remove();
            }
        }

        document.getElementById('payment-button').addEventListener('click', function (e) {
            e.preventDefault();

            const customer = document.querySelector('[name="selbuy"]')?.value;
            const paymentMethod = document.querySelector('[name="mode"]')?.value;

            if (!paymentMethod || selectedProducts.length === 0) {
                alert('Select payment method and at least one product.');
                return;
            }

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

            const dataToSend = selectedProducts.map(p => ({
                productId: p.id,
                mode: paymentMethod,
                qty: p.qty,
                customer: customer
            }));

            fetch("{% url 'p1' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
            })
            .catch(error => {
                console.error('Order submission error:', error);
                alert('Failed to process order.');
            });
        });
    </script>
</body
